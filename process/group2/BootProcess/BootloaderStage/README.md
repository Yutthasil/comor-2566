# Bootloader Stage
Bootloader เป็นโปรแกรมขนาดเล็กสำหรับโหลดระบบปฏิบัติการ งานหลักของBootloader คือดำเนินการสามประการกับเคอร์เนล: ค้นหาบนดิสก์ ใส่ลงในหน่วยความจำ และดำเนินการ(execute)ด้วยตัวเลือกที่ให้มา โดย Bootloader นั้นจะมีอยู่ 2 stage
1. **first stage bootloader (stage 1)** ถูกโหลดมาจาก Firmware stage โดย bootloader stage 1 จะเก็บ program code และ ตารางพาร์ติชัน ทำหน้าที่ในการค้นหาและโหลด bootloader stage 2 โดยการค้นหาจะใช้ตารางพาร์ติชันในการค้นหา
2. **second stage bootloader (stage 2)** หน้าที่ของ bootloader stage 2 คือการโหลดอิมเมจเคอร์เนลลินุกซ์ลงในหน่วยความจำ
- ระบบ Linux นั้นมี bootloader หลายประเภท ซึ่งจะยกมา 2 ตัว คือ
<a name = "LILO"></a>
## 1. LILO (Linux Loader)
### LILO คืออะไร? 
LILO ใช้ในการโหลด Linux ลงในหน่วยความจำ และบูตระบบปฏิบัติการจาก ฮาร์ดดิสก์ และไม่ขึ้นอยู่กับระบบไฟล์
LILO จัดการงานบางอย่าง เช่น ค้นหาเคอร์เนล ระบุโปรแกรมที่รองรับอื่นๆ โหลดหน่วยความจำ และสตาร์ทเคอร์เนล 
Config File ของ LILO  อยู่ที่ “/etc/lilo.conf” LILO  อ่านConfig File  นี้ และจะแจ้งให้ LILO ทราบว่าควรวาง Bootloader ไว้ที่ไหน
### ขั้นตอนการบูต
เมื่อ Bootloader LILO ถูกโหลดมาทำงาน ตัวอักษร L,I,O จะถูกแสดงขึ้น ซึ่งแต่ละตัวอักษรนั้นจะบ่งบอกถึงการทำงานบางอย่าง
1. **ไม่มีตัวอักษรใดแสดง**: แสดงว่ายังไม่มีส่วนใดส่วนหนึ่งของ LILO ถูกโหลด
2.  **L**:  first stage bootloader ถูกโหลด หากขั้นตอนนี้เกิดข้อผิดพลาด ปัญหาอาจเกิดกับ second stage bootloader  ซึ่งสิ่งนี้อาจเกิดขึ้นเนื่องจากพารามิเตอร์ดิสก์บางตัวที่ระบุในไฟล์กำหนดค่าของ lilo ไม่ถูกต้อง
3.  **LI**: แสดงว่า second stage bootloader ถูกโหลดแล้วและไม่สามารถดำเนินการได้ มันสามารถเกิดขึ้นได้เนื่องจากปัญหาคล้ายกับ L.
4. **LIL**: ในขั้นตอนนี้ second stage bootloaderได้การดำเนินการ(execution)เสร็จสิ้นแล้ว หากล้มเหลว ขั้นตอนนี้บ่งชี้ว่ามีปัญหาที่สื่อ(media)หรือไฟล์ map ที่ระบุในไฟล์ config มีปัญหาบางอย่าง
5. **LIL?**: หมายความว่าโหลด second stage bootloader ใน address ที่ไม่ถูกต้อง
6. **LIL-**:  บ่งชี้ว่าตาราง descriptor เสียหาย
7. **LILO**: โหลดทุกส่วนสำเร็จ
### การกำหนดค่า LILO(Configuring)
Configuring file ของ LILO อยู่ที่ “/etc/lilo.conf”
|ค่าในไฟล์|ความหมาย|
|  --------  |  -------  |
| **boot=/dev/hda**| สิ่งนี้จะบอก LILO ว่าจะติดตั้ง bootloader ที่ไหน  |
| **map=/boot/map**| ไฟล์นี้ถูกสร้างขึ้นโดยอัตโนมัติโดย LILO ระหว่างการบูทเครื่อง |
| **install=/boot/boot.b** | ไฟล์นี้มีโค้ด “bootstrap” สำหรับเริ่มระบบปฏิบัติการและเก็บทั้งส่วนหลัก(stage 1)และรอง(stage 2)ของ bootloader |
| **prompt**| สิ่งนี้เป็นการบอกให้ LILO ใช้ UI ตัวอย่างเช่น เพื่อเลือกระบบปฏิบัติการหรือป้อนพารามิเตอร์สำหรับเคอร์เนล Linux |
| **timeout=50**| แจ้ง LILO ว่าจะรอ prompt นานเท่าใดก่อนที่จะบูตระบบปฏิบัติการเริ่มต้น|
| **image=/boot/vmlinuz-2.0.36** | ชื่อของเคอร์เนล Linux เพื่อให้ LILO บูต|
| **label=linux** |ระบุระบบปฏิบัติการเริ่มต้นที่จะบูต|
| **root=/dev/hda2** |บอก LILO ว่าระบบไฟล์ OS อยู่ที่ใด|
| **read-only** |บอกให้ LILO ทำการบูทครั้งแรกกับระบบไฟล์แบบอ่านอย่างเดียว(read-only)|
| **other=/dev/hda1** |บอกให้ LILO บูตระบบปฏิบัติการอื่นที่ไม่ใช่ Linux|
| **label=win** |ระบุระบบปฏิบัติการเริ่มต้นที่จะบูต|
### **LILO command options**
การเรียกใช้คำสั่ง
> lilo [-option]

|option|ความหมาย|
|  --------  |  -------  |
| -c cnfig-file | ระบุไฟล์ configuration ทางเลือกอื่นที่ไม่ใช่ไฟล์เริ่มต้น /etc/lilo.conf  |
| -q| แสดงรายการในไฟล์ map |
| -V | แสดงหมายเลขเวอร์ชันของ LILO |
| -v| ระบุเอาต์พุตแบบละเอียด |
| -u device-name |ถอนการติดตั้ง LILO และกู้คืนบูตเซกเตอร์ที่บันทึกไว้ หลังจากตรวจสอบ timestamp device-name คือชื่ออุปกรณ์ที่ติดตั้ง LILO|
| -U device-name | สิ่งนี้เหมือนกับ -u แต่ไม่ได้ตรวจสอบtimestamp|
| -R command-line |ตั้งค่าคำสั่งเริ่มต้นสำหรับบูตโหลดเดอร์ในครั้งถัดไปที่เรียกใช้งาน|
<a name = "GRUB"></a>
## 2. GRUB(Grand Unified Bootloader)

### GRUB คืออะไร?
เป็น bootloader และ boot manager สำหรับ Linux และระบบปฏิบัติการ Unix อื่นๆ GRUB เริ่มต้นหลังจากที่ BIOS เสร็จสิ้นการทดสอบฮาร์ดแวร์ที่จำเป็นและโหลดจาก Master Boot Record (MBR) เมื่อโหลดแล้ว GRUB จะเข้าควบคุมระบบและโหลดเคอร์เนล Linux
> **boot manager** จะแสดงอินเทอร์เฟซให้ผู้ใช้จัดการการกำหนดค่าการบูตและเลือกระบบที่จะโหลด อินเทอร์เฟซอาจเป็นเมนูเริ่มต้นของ GRUB หรือเป็นตามแต่ละรุ่นของคอมพิวเตอร์

ปัจจุบัน GRUB มี 2 เวอร์ชันสำหรับ Linux
- **GRUB Legacy (GRUB 1)** GRUB เวอร์ชันที่เลิกใช้ไปแล้ว แต่ยังคงพบได้ใน Linux รุ่นเก่าบางรุ่น
- **GRUB 2** GRUB เวอร์ชันนี้รองรับสถาปัตยกรรมพีซีใหม่  และระบบไฟล์ , สภาพแวดล้อม RAID และ LVM 
- linux ส่วนใหญ่ในปัจจุบันใช้ GRUB 2

### ขั้นตอนการบูต
กระบวนการบูต GRUB ประกอบด้วยสองถึงสามขั้นตอน
- **ขั้นตอน 1** GRUB จะเริ่มต้นทันทีหลังจากที่ BIOS/UEFI โหลด GRUB จาก MBR/ESP GRUB ใช้พื้นที่ขนาดเล็กที่จัดสรรไว้สำหรับโค้ดเริ่มต้นใน MBR เพื่อเริ่มต้นขั้นตอนถัดไปที่ซับซ้อนยิ่งขึ้น
- **ขั้นตอน 1.5** ขั้นตอนนี้เป็นตัวเลือกช่วยให้สามารถอ่านไฟล์ ขั้นตอน 2 แบบไดนามิกได้ GRUB รองรับระบบไฟล์หลายระบบและ ต้องติดตั้งระบบไฟล์ที่สอดคล้องกับระบบไฟล์ซึ่งมีไฟล์ ขั้นตอน 2 อยู่ หากไม่มีขั้นตอน 1.5 ในระหว่างการติดตั้ง GRUB ขั้นตอน 2 จะโหลดแบบคงที่(static)
- **ขั้นตอน 2** ขั้นตอนสุดท้ายของกระบวนการบูต GRUB นั้นยาวที่สุดและซับซ้อนที่สุด ขั้นตอนนี้ประกอบด้วยขั้นตอนทั้งหมดที่จำเป็นสำหรับการเริ่มต้นระบบ ซึ่งประกอบไปด้วย
> - การแสดงเมนูการบูต
> - โหลดเคอร์เนลระบบปฏิบัติการ
> - การเริ่มต้นเคอร์เนล
> - การเริ่มต้นพื้นที่ผู้ใช้(user-space)
### การกำหนดค่า GRUB(Configuring)
สามารถ Configuring GRUB ได้ผ่านทาง **/etc/default/grub**
|ค่าในไฟล์|ความหมาย|
|  --------  |  -------  |
| **GRUB_TIMEOUT=5**| ค่าของคีย์นี้จะกำหนดระยะเวลาที่เมนูการเลือก GRUB จะแสดงผล  |
| **GRUB_DISTRIBUTOR="$(sed 's, release .*$,,g' /etc/system-release)"**| คีย์นี้กำหนด sed(stream editor) ที่ระบุถึงหมายเลขการจัดจำหน่ายออกจากไฟล์ /etc/system-release เพิ่อให้ทราบถึง โครงสร้างการจัดเก็บข้อมูลตามแต่ละหมายเลข|
| **GRUB_DEFAULT=saved** | กำหนดว่าเคอร์เนลใดที่จะบู๊ตตามค่าเริ่มต้น "saved" หมายถึงเคอร์เนลล่าสุด |
| **GRUB_DISABLE_SUBMENU=true**| สร้างโครงสร้างเมนูย่อยๆของเคอร์เนลสำหรับหน้า GRUB menu "false" จะทำให้สามารถใช้เมนูย่อยได้|
| **GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"**| กำหนดพารามิเตอร์ ที่จะถูกนำไปต่อท้ายในบรรทัดสุดท้ายของ command-line เคอร์เนล "quiet splash" ทำให้เห็นเป็นจอสีดำที่แสดงเพียงแค่ตัวหนังสือ |
| **GRUB_DISABLE_RECOVERY="true"** | กำหนดว่าให้สร้างรายการกู้คืนหรือไม่ "true" คือไม่ให้สร้าง|
| **GRUB_DISABLE_OS_PROBER=true** |ปิดใช้งานการตรวจจับระบบปฏิบัติการแบบไดนามิก|
### คำสั่งใน GRUB CLI
GRUB CLI สามารถเข้าได้โดยการกดปุ่มที่กำหนดตอนที่ linux กำลังถูก boot
|คำสั่ง|ความหมาย|
|  --------  |  -------  |
| **boot**| เริ่มทำการ boot  |
| **cat**| แสดงเนื้อหาของไฟล์ผ่านทางเอาต์พุต|
| **configfile** | โหลด configuration file. |
| **initrd**| โหลดไฟล์ initrd.img|
| **insmod**| แสดงเนื้อหาของไดเร็กทอรีหรือพาร์ติชัน |
| **lsmod** | แสดงรายการโมดูลที่ถูกโหลด|
| **normal** |เปิดใช้งานโมดูลปกติ|
| **search** |ค้นหาอุปกรณ์|
| **set** |ตั้งค่าตัวแปรสภาพแวดล้อม(environment variable)|

# แหล่งอ้างอิง
- https://www.baeldung.com/linux/boot-process
- https://www.scaler.com/topics/booting-process-in-linux/
- https://www.interserver.net/tips/kb/what-is-lilo/
- https://phoenixnap.com/kb/what-is-grub
- https://opensource.com/article/17/3/introduction-grub2-configuration-linux
- https://help.ubuntu.com/community/Grub2/Setup
- https://www.redswitches.com/blog/grub-rescue-commands/#The-GRUB-Rescue-Commands
