# System Time

System time หมายถึงเวลาที่ระบบคอมพิวเตอร์หรืออุปกรณ์อื่น ๆ ใช้เพื่อจัดการกับเหตุการณ์ต่าง ๆ ภายในระบบนั้น ๆ โดยปกติจะเป็นเวลาปัจจุบันของโลก (วินาที นาที ชั่วโมง วัน เดือน ปี) ซึ่งถูกแสดงผ่านทางอุปกรณ์แสดงผลหรือไปยังโปรแกรมที่ทำงานอยู่บนระบบนั้น ๆ การมีเวลาที่ถูกต้องในระบบเป็นสิ่งสำคัญอย่างมาก เนื่องจากมีผลต่อการทำงานของโปรแกรมและการเชื่อมต่อในเครือข่าย การตั้งค่าเวลาไม่ถูกต้องอาจทำให้เกิดปัญหาในการทำงานของระบบและความไม่สะดวกในการใช้งานอุปกรณ์ต่าง ๆ ดังนั้น การจัดการกับ system time เป็นเรื่องสำคัญในการดูแลระบบคอมพิวเตอร์


## ประเภทของ clock

1. Hardware clock
2. System clock

<a id="hwclock"></a>
## Hardware Clock

นาฬิกาฮาร์ดแวร์ (Hardware Clock) เป็นนาฬิกาที่ติดตั้งบนเมนบอร์ดของคอมพิวเตอร์หรืออุปกรณ์อื่น ๆ ซึ่งใช้ในการเก็บเวลาและวันที่ โดยมักจะมีการให้พลังงานโดยตรงจากแบตเตอรี่ CMOS ซึ่งติดตั้งบนเมนบอร์ดเพื่อให้นาฬิกาฮาร์ดแวร์ยังคงทำงานได้แม้ระบบจะถูกปิดลงด้วย นาฬิกาฮาร์ดแวร์เป็นส่วนสำคัญของระบบคอมพิวเตอร์เนื่องจากมีบทบาทในการรักษาการเริ่มต้นระบบและการปรับปรุงเวลาของระบบให้เป็นไปตามเวลาสากลหรือเวลาท้องถิ่นตามที่กำหนด นอกจากนี้ ในบางกรณี นาฬิกาฮาร์ดแวร์ยังใช้ในการทำงานร่วมกับระบบปฏิบัติการเพื่อรักษาความถูกต้องของเวลาในระบบได้เสมอ.

เมื่อระบบเปิดใช้งานและกำลังทำงานอยู่ สามารถดูและตั้งค่าวันที่และเวลาของนาฬิกาฮาร์ดแวร์ได้โดยใช้คำสั่ง  `hwclock` ใน Linux ตามที่อธิบายไว้

1. ### Display Hardware Clock Date and Time
	เพื่อแสดงวันที่และเวลาของนาฬิกาฮาร์ดแวร์ของระบบใน Linux สามารถพิมพ์คำสั่ง `hwclock` ได้เลย คำสั่งนี้จะแสดงวันที่และเวลาเดียวกันที่จะเห็นจากหน้าจอ BIOS แล้วสามารถใช้ตัวเลือก `-r` หรือ `--show` พร้อมกับคำสั่ง `hwclock` เพื่อแสดงวันที่และเวลาได้ด้วย ตัวอย่างเช่น:
		 
	```
	$ hwclock -r
	```
	or
		
	```
	$ hwclock --show
	```

2. ###  Copy System Time to Hardware Time
	ใช้คำสั่ง `hwclock` ดังที่แสดงด้านล่างเพื่อตั้งค่านาฬิกาฮาร์ดแวร์ให้เหมือนกับนาฬิกาของระบบ

	```
	$ hwclock -w
	```
	or
		
	```
	$ hwclock --systohc
	```
3. ### Set Hardware Clock Date and Time Manually
	แทนที่จะคัดลอกวันที่และเวลาของระบบไปยังนาฬิกาฮาร์ดแวร์ สามารถตั้งค่าค่าเวลาด้วยตนเองโดยใช้ตัวเลือก `--set` และ `--date` ตามที่แสดงไว้ด้านล่าง

	```
	$ hwclock --set --date “4/1/2025 18:30:50”
	```
4. ### Copy Hardware Time to System Time	
	เมื่อนาฬิกาฮาร์ดแวร์ของแสดงวันที่และเวลาที่ถูกต้อง แต่นาฬิกาของระบบไม่ถูกต้อง สามารถใช้ตัวเลือก `-s` ดังที่แสดงไว้ด้านล่างเพื่อคัดลอกเวลาของฮาร์ดแวร์ไปยังเวลาระบบได้

	```
	$ hwclock -s
	```
	or
		
	```
	$ hwclock -hctosys
	```
5. ### hwclock Debug Mode
	เมื่อใช้ตัวเลือก `--debug` กับคำสั่ง `hwclock` มันจะแสดงข้อมูล debug บางส่วนซึ่งแสดงถึงการทำงานของคำสั่ง `hwclock` โดยละเอียด

	```
	$ hwclock --systohc --debug
	```
	and
		
	```
	$ hwclock -hctosys --debug
	```
6. ### Adjust the Hardware Clock
	มื่อระบบเริ่มต้นขึ้น มันจะเอาเวลามาจากนาฬิกาฮาร์ดแวร์ ไฟล์ `/etc/adjtime` ถูกใช้โดยตัวเลือก `hwclock --adjust` เพื่อควบคุมการปรับแต่ง

	```
	$ hwclock --adjust
	```
7. ### hwclock Test Mode
	เมื่อคุณเปลี่ยนแปลงสิ่งต่าง ๆ โดยใช้คำสั่ง `hwclock` พร้อมกับตัวเลือก `--test` คุณสามารถดำเนินการคำสั่งโดยไม่จริงๆทำการเปลี่ยนแปลงใด ๆ

	ตัวเลือก `--systz` จะเปลี่ยนโซนเวลาระบบตามที่กำหนด แต่เนื่องจากเราให้ `--test` มันจะไม่ทำการเปลี่ยนแต่จะยังคงดำเนินการคำสั่งโดยไม่มีปัญหาใด ๆ

	```
	$ hwclock --systz --test
	```
<a id="sysclock"></a>
## System clock

ถูกจัดการโดยระบบปฏิบัติการ มันถูกใช้ในการประสานการทำงานทุกอย่างภายในระบบคอมพิวเตอร์ มันประสานการทำงานทั้งซอฟต์แวร์และอุปกรณ์ฮาร์ดแวร์ของคอมพิวเตอร์

1. ### Read clock
	  เพื่อตรวจสอบเวลาปัจจุบันของนาฬิกาของระบบ

	```
	$ date
	```
2. ### Set system clock
	เพื่อตั้งค่าเวลาของนาฬิกาของระบบโดยตรง
	```
	$ date -s "03/12/2025 16:57:00“
	```
## Setting Timezone

โซนเวลาเป็นพื้นที่ภูมิศาสตร์ที่มีเวลามาตรฐานเดียวกัน เรามักจะตั้งค่าโซนเวลาขณะที่ติดตั้งระบบปฏิบัติการ แต่สามารถเปลี่ยนแปลงได้ง่ายๆ ในภายหลัง

การใช้โซนเวลาที่ถูกต้องเป็นสิ่งสำคัญสำหรับงานและกระบวนการที่เกี่ยวข้องกับระบบหลายระบบ เช่น เดมอน (cron daemon) ใช้โซนเวลาของระบบสำหรับการดำเนินการงาน cron โซนเวลายังถูกใช้สำหรับการประทับเวลาในบันทึกประวัติการใช้งานด้วย

1. ### Checking the Current Time Zone
	เพื่อดูโซนเวลาปัจจุบัน ใช้คำสั่ง timedatectl โดยไม่มีตัวเลือกหรืออาร์กิวเมนต์ใดๆ

	```
	$ timedatectl
	```
                      Local time: Tue 2019-12-03 16:30:44 UTC
                  Universal time: Tue 2019-12-03 16:30:44 UTC
                        RTC time: Tue 2019-12-03 16:30:44
                       Time zone: Etc/UTC (UTC, +0000)
       System clock synchronized: no
       systemd-timesyncd.service active: yes
				  RTC in local TZ: no
2. ### Changing the Time Zone
	เพื่อดูโซนเวลาทั้งหมดที่มีอยู่ ใช้คำสั่ง `timedatectl` หรือแสดงรายการไฟล์ในไดเรกทอรี `/usr/share/zoneinfo`

	```
	$ timedatectl set-timezone <your_time_zone>
	```
 <a id="ntp"></a>
## Network Time Protocol (NTP)

ตามความหมายแล้วมันคือ networking protocol ที่ใช่สำหรับ sync time ของ server ทุกเครื่องใน network ให้ตรงกัน ผ่าน packet-switch ซึ่ง ntp เป็น protocol ที่เก่าแก่มาก

สาเหตุที่่ต้องมี NTP นั้นก็เพราะ นาฬิกา หรือ clock ของ server, computer ใน network ไม่ได้เที่ยงตรงเท่ากันหมด บางครั้งการคลาดเคลือนกันเพียงหลักวินาทีอาจจะทำให้ application ที่ใช้งานสื่อสารกันผิดพลาดได้ และยิ่งในระบบ server ขนาดใหญ่ที่มีการ run ต่อเนื่องกันเป็นเวลานานหลายปี ย่อมมีความคลาดเคลือนไปบ้างอยู่แล้ว เพราะฉะนั้น NTP จึงเข้ามาช่วยในการทำ synchronize computer ในระบบ network เราให้แม่นยำในระดับ millisecond ความคลาดเคลื่อนที่อาจจะเกินขึ้นใน network latency มีเพียงแค่ 10 ms. สำหรับบน Internet และจะเหลือเพียง 1 ms. ภายใน local network

Protocol ที่ใช้จะอยู่ในรูป client-server หรือ peer-to-peer โดยจพทำการรับส่งข้อมูล timestamps ผ่านทาง UDP

<a id="strlayer"></a>
### Stratum layer

NTP ทำงานเป็นลำดับชั้น หรือ layer โดยแต่ละ layer จะเรียกว่า “stratum” และเรียงตามตัวเลขจากบนสุดคือ 0 ลงไปเรื่อยๆ หมายความว่า stratum1 ทำการ sync กับ server บนสุด และ stratum2 ก็จะ sync กับ computer ที่อยู่ใน stratum1 ต่อมาอีกที ซึ่งจะเห็นว่ายิ่ง stratum มีค่าต่ำจะยิ่งมีความแม่นยำมากกว่า stratum สูงๆ สำหรับวง telecom ตัว ntp จะมีความสำคัญมากเพราะ signaling ที่ส่งกันภายใน network มีความเร็วสูงกว่าระบบ TCP ที่เราใช้กันปกติ รูปแบบของ stratum ที่ใช้งานจึงมีลักษณะนี้

 - **Stratum 0**
	 
	 มีความแม่นยำสูงสุด เพราะเหมือน master clock ทำงานโดยใช้ atomic clokc, GPS clock หรือ radio clock โดยจะสร้าง signal pulse ทุกวินาที เพื่อ sync ให้กับ computer ที่ต่อเข้ามา เราเรียกกันว่า “reference clock”
 
 - **Strarum 1**
	 
	 เป็น computer ที่ ทำการ sync กับ stratum 0 ทุกๆ ไม่กี่ microsecond ซึ่ง Stratum 1 server ทำการ sync กับ Stratum 1 server ตัวอื่นๆ เพื่อเป็นการเช็ก และ backup อีกที เราเรียกว่า “Primary Time Server”
	 
 - **Stratum2**

	เป็นพวก computer ที่่ทำการ sync ข้าม network มายัง stratum 1 server พวก stratum 2 นี้จะทำการ sync กับ stratum 1 server และเช็กกับ stratum 2 ตัวอื่นๆเพื่อความแม่นยำ

 - **Stratum 3**
 
	 เป็นพวก computer ที่่ทำการ sync กับ stratum 2 server ใช้วิธีการ sync แบบเดียวกับ stratum 2 และก็สามารถเปิดให้ stratum 4 เข้ามา sync กับตนได้

![enter image description here](https://i0.wp.com/saixiii.com/wp-content/uploads/2017/05/ntp-hierarchy.png?resize=768,653&ssl=1)

1. ### Install ntp
	สำหรับ Linux สามารถ install ผ่าน repository ได้ เช่น Ubuntu

	```
	$ sudo apt-get install ntp
	```
2. ### Configure NTP server
	โดยปกติจะมี configure defult มาให้ใน file

	```
	$ vi /etc/ntp.conf
	```
	```
	server 0.ubuntu.pool.ntp.org
	server 1.ubuntu.pool.ntp.org
	server 2.ubuntu.pool.ntp.org
	server 3.ubuntu.pool.ntp.org
	```
3. ### ตรวจสอบ status NTP

	```
	$ ntpq -p
	 remote refid st t when poll reach delay offset jitter
	 ==============================================================================
	 0.ubuntu.pool.n .POOL. 16 p - 64 0 0.000 0.000 0.000
	 1.ubuntu.pool.n .POOL. 16 p - 64 0 0.000 0.000 0.000
	 2.ubuntu.pool.n .POOL. 16 p - 64 0 0.000 0.000 0.000
	 3.ubuntu.pool.n .POOL. 16 p - 64 0 0.000 0.000 0.000
	 ntp.ubuntu.com .POOL. 16 p - 64 0 0.000 0.000 0.000
	-203.158.247.150 202.47.249.21 2 u 38 64 3 10.116 -19.639 31.226
	+103.22.182.121 202.47.249.21 2 u 36 64 3 11.413 -12.157 31.751
	*113.53.247.3 (1 .GNSS. 1 u 36 64 3 10.138 -14.026 30.545
	-ntp02.cpe.rmutt 179.43.76.147 2 u 99 64 2 10.082 -49.719 0.000
	+122.155.169.213 202.47.249.21 2 u 33 64 3 9.054 -12.063 31.938
	-alphyn.canonica 132.246.11.231 2 u 32 64 3 280.883 -13.324 32.226
	```
4. ### หากมีการแก้ไข configure ต้องทำการ restart service

	```
	$ sudo service ntp restart
	```
<a id="chrony"></a>
## Understanding chrony

**Chrony** คือการใช้งาน Network Time Protocol (NTP) ที่ยืดหยุ่น ใช้เพื่อซิงโครไนซ์นาฬิการะบบจากเซิร์ฟเวอร์ NTP, นาฬิกาอ้างอิง หรือผ่านการป้อนข้อมูลด้วยตนเอง

นอกจากนี้ยังสามารถใช้เซิร์ฟเวอร์ **NTPv4** เพื่อให้บริการเวลาแก่เซิร์ฟเวอร์อื่นในเครือข่ายเดียวกัน มีไว้เพื่อให้ทำงานได้อย่างไร้ที่ติภายใต้สภาวะต่างๆ เช่น การเชื่อมต่อเครือข่ายไม่ต่อเนื่อง เครือข่ายที่มีโหลดสูง อุณหภูมิที่เปลี่ยนแปลงซึ่งอาจส่งผลต่อนาฬิกาของคอมพิวเตอร์ทั่วไป

**Chrony**  มาพร้อมกับสองโปรแกรม:

-   **chronyc**  – อินเทอร์เฟซบรรทัดคำสั่งสำหรับ chrony
-   **chronyd**  – daemon ที่สามารถเริ่มต้นได้ในเวลาบูต

	ในการตรวจสอบว่าซิงโครไนซ์จริงหรือไม่ เราจะใช้โปรแกรมบรรทัดคำสั่ง `chronyc` ซึ่งมีตัวเลือกการติดตามซึ่งจะให้ข้อมูลที่เกี่ยวข้อง
	```
	$ chronyc tracking
	```
	![enter image description here](https://th.linux-console.net/common-images/install-chrony-in-centos-ubuntu-linux/Check-Chrony-Synchronization-in-Linux.png)

	ไฟล์ที่ระบุไว้ให้ข้อมูลต่อไปนี้:

-   **รหัสอ้างอิง**  – รหัสอ้างอิงและชื่อที่คอมพิวเตอร์กำลังซิงค์อยู่
-   **Stratum**  – จำนวนการกระโดดไปยังคอมพิวเตอร์ที่มีนาฬิกาอ้างอิงติดอยู่
-   **เวลาอ้างอิง**  – นี่คือเวลา UTC ที่มีการวัดค่าล่าสุดจากแหล่งอ้างอิง
-   **เวลาของระบบ**  – ความล่าช้าของนาฬิการะบบจากเซิร์ฟเวอร์ที่ซิงโครไนซ์
-   **ออฟเซ็ตล่าสุด**  – ออฟเซ็ตโดยประมาณของการอัปเดตนาฬิกาล่าสุด
-   **ค่าชดเชย RMS**  – ค่าเฉลี่ยระยะยาวของค่าชดเชย
-   **ความถี่**  – นี่คืออัตราที่นาฬิกาของระบบอาจผิดพลาดหาก  **chronyd**  ไม่แก้ไข โดยมีหน่วยเป็น ppm (ส่วนในล้านส่วน)
-   **ความถี่ตกค้าง**  – ความถี่ตกค้างบ่งชี้ความแตกต่างระหว่างการวัดจากแหล่งอ้างอิงและความถี่ที่กำลังใช้อยู่
-   **เอียง**  – ขอบเขตข้อผิดพลาดโดยประมาณของความถี่
-   **รูตดีเลย์**  – เส้นทางทั้งหมดของเครือข่ายที่ล่าช้าไปยังสตราตัมคอมพิวเตอร์ ซึ่งคอมพิวเตอร์กำลังซิงค์อยู่
-   **สถานะ Leap**  – นี่คือสถานะ Leap ซึ่งสามารถมีค่าใดค่าหนึ่งต่อไปนี้ – ปกติ แทรกวินาที ลบวินาที หรือไม่ซิงโครไนซ์

	หากต้องการตรวจสอบข้อมูลเกี่ยวกับแหล่งที่มาของ chrony คุณสามารถออกคำสั่งต่อไปนี้

	```
	$ chronyc sources
	```
	![enter image description here](https://th.linux-console.net/common-images/install-chrony-in-centos-ubuntu-linux/Check-Chrony-Sources.png)

## REFERENCES

 - https://www.cyberciti.biz/faq/linux-display-date-and-time/
 - https://wiki.archlinux.org/title/System_time
 - https://developer.toradex.com/software/linux-resources/linux-features/real-time-clock-rtc-linux/
 - https://linuxize.com/post/how-to-set-or-change-timezone-in-linux/
 - https://saixiii.com/what-is-ntp/
 - https://th.linux-console.net/?p=153
